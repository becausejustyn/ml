---
title: "R Notebook"
output: html_notebook
---

# PCA

```{r}
library(tidyverse)
```

```{r}
usa_arrests <- as_tibble(USArrests, rownames = "state")
```

```{r}
usa_arrests %>%
  select(-state) %>%
  map_dfr(mean)
```

Because different measures are used, we will want to scale the values to be on the same type of scale.

```{r}
usa_arrests_pca <- usa_arrests %>%
  select(-state) %>%
  prcomp(scale = TRUE)

usa_arrests_pca
```

```{r}
library(broom)

#location of the observation in PCA space
tidy(usa_arrests_pca, matrix = "scores")
```

```{r}
#loadings
tidy(usa_arrests_pca, matrix = "loadings")
```

This tells us how each variable contributes to each principal component. 

```{r}
tidy(usa_arrests_pca, matrix = "loadings") %>%
  ggplot(aes(value, column)) +
  facet_wrap(~ PC) +
  geom_col()
```

```{r}
arrest_pca %>%
  mutate(
    terms = tidytext::reorder_within(
      terms, abs(value), component)) %>%
  ggplot(aes(
    abs(value), terms, 
    fill = value > 0)) +
  geom_col() +
  facet_wrap(~component, scales = "free_y") +
  tidytext::scale_y_reordered() +
  scale_fill_manual(
    values = c("#b6dfe2", "#0A537D")) +
  labs(
    x = "Absolute value of contribution",
    y = NULL, fill = "Positive?"
  ) 
```


Lastly, we can set matrix = "eigenvalues" and get back the explained standard deviation for each PC including as a percent and cumulative which is quite handy for plotting.

```{r}
tidy(usa_arrests_pca, matrix = "eigenvalues")
```

To visualise

```{r}
tidy(usa_arrests_pca, matrix = "eigenvalues") %>%
  ggplot(aes(PC, percent)) +
  geom_col()
```

```{r}
pca_rec2 %>% 
  tidy(id = "pca", type = "variance") %>% 
  dplyr::filter(terms == "percent variance") %>% 
  ggplot(aes(x = component, y = value)) + 
  geom_col(fill = "#b6dfe2") + 
  xlim(c(0, 5)) + 
  ylab("% of total variance")
```


Lastly, we have the augment() function which will give you back the fitted PC transformation if you apply it to the prcomp() object directly

```{r}
augment(usa_arrests_pca)
```

and will apply this transformation to new data by passing the new data to newdata

```{r}
augment(usa_arrests_pca, newdata = usa_arrests[1:5,])
```

## Via tidymodels

```{r}
library(tidymodels)
```

```{r}
pca_rec <- recipe(~., data = usa_arrests) %>%
  step_normalize(all_numeric()) %>%
  step_pca(all_numeric(), id = "pca") %>%
  prep()

# get the fitted PC transformation of our numerical variables
pca_rec %>%
  bake(new_data = NULL)
```

```{r}
pca_rec2 <- recipe(~., data = usa_arrests) %>% 
  update_role(state, new_role = "id") %>% 
  step_naomit(all_predictors()) %>% 
  step_normalize(all_predictors()) %>%
  step_pca(all_predictors(), id = "pca") %>% 
  prep()

arrest_pca <- pca_rec2 %>% 
  tidy(id = "pca") 
```


```{r}
#Here id = "pca" refers to the second step of pca_rec. We get the scores with type = "coef"
tidy(pca_rec, id = "pca", type = "coef")
```

```{r}
#And the eigenvalues with type = "variance".
tidy(pca_rec, id = "pca", type = "variance")
```

```{r}
#We can either specify how many components we want with num_comp (or rank. in prcomp())
recipe(~., data = usa_arrests) %>%
  step_normalize(all_numeric()) %>%
  step_pca(all_numeric(), num_comp = 3) %>%
  prep() %>%
  bake(new_data = NULL)
```

```{r}
#or using a threshold to specify how many components to keep by the variance explained. So by setting threshold = 0.7 step_pca() will generate enough principal components to explain 70% of the variance.
recipe(~., data = usa_arrests) %>%
  step_normalize(all_numeric()) %>%
  step_pca(all_numeric(), threshold = 0.7) %>%
  prep() %>%
  bake(new_data = NULL)
```

### Plot PCA loadings + scores

```{r}
# get pca loadings into wider format
pca_wider <- arrest_pca %>% 
  tidyr::pivot_wider(names_from = component, id_cols = terms)
```

```{r}
#https://allisonhorst.github.io/palmerpenguins/articles/articles/pca.html

# define arrow style
arrow_style <- arrow(length = unit(.05, "inches"),
                     type = "closed")


pca_plot <- juice(pca_rec) %>%
  ggplot(aes(PC1, PC2)) +
  geom_point(aes(color = state), 
             alpha = 0.8, 
             size = 2) 
  #scale_colour_manual(values = c("darkorange","purple","cyan4")) 

pca_plot +
  geom_segment(data = pca_wider,
               aes(xend = PC1, yend = PC2), 
               x = 0, 
               y = 0, 
               arrow = arrow_style) + 
  geom_text(data = pca_wider,
            aes(x = PC1, y = PC2, label = terms), 
            hjust = 0, 
            vjust = 1,
            size = 5, 
            color = '#0A537D') 
```

